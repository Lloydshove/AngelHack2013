var gspot = angular.module('gspot', ['ngResource', 'ui.map','ui.event']);

gspot.run(function($rootScope){
    //TODO (1): Give your blog a name and a isAddingPost flag to control the display

    $rootScope.mapHeight = "1000px";
    $rootScope.mapWidth = "100%";

});

var spotsResources = gspot.factory('spotsResources', function($resource){
	return $resource('sample.json?southWestLat=:southWestLat&southWestLng=:southWestLng&northEastLat=:northEastLat&northEastLng=:northEastLng', {
		southWestLat : '@southWestLat',
		southWestLng : '@southWestLng',
		northEastLat : '@northEastLat',
		northEastLng : '@northEastLng'
	}) 	
});

var mainCtrl = gspot.controller('mainCtrl',['$scope','spotsResources', function mainCtrl($scope, spotsResources) {
	$scope.markers = [];
	$scope.spots = [];
	
	$scope.mapStyle = {
		height: '300px',
		width: '100%'
	}
	
	$scope.displayBoard = false;
    var singapore = new google.maps.LatLng(1.2589483280609064, 103.86431503295901);  
    
    $scope.mapOptions = {
        center: singapore,
        zoom: 15,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    //Markers should be added after map is loaded
    /*
    $scope.onMapIdle = function() {
    
    	spotsResources.query(function(response){

    		$scope.spots = response;
    		
    		for(var i = 0; i < $scope.spots.length ; i++){
    		//Add each spot a marker object
    		
    			var position = new google.maps.LatLng($scope.spots[i]['lat'], $scope.spots[i]['lng']);
    			
    			var marker = new google.maps.Marker({
    				map: $scope.myMap,
    				position: position
    			});
    			
    			$scope.markers[i] = marker
    			
    		}
    		
    	});
    	
    };
    */

    $scope.markerClicked = function(index) {
    	$scope.displaySpot = $scope.spots[index];
        $scope.displayBoard = true;
        
        $scope.mapStyle.height = '200px';
        
        $scope.map.setCenter($scope.markers[index].getPosition());
    };
    
    $scope.showSpots = function(){
    
    	$scope.spots = [];
    	$scope.markers = [];
    	
    	var southWestLat = $scope.map.getBounds().getSouthWest().lat();
    	var southWestLng = $scope.map.getBounds().getSouthWest().lng();
    	var northEastLat = $scope.map.getBounds().getNorthEast().lat();
    	var northEastLng = $scope.map.getBounds().getNorthEast().lng();
    
    	spotsResources.query({
			southWestLat : southWestLat,
			southWestLng : southWestLng,
			northEastLat : northEastLat,
			northEastLng : northEastLng
			},
			function(response){

    		$scope.spots = response;
    		
    		for(var i = 0; i < $scope.spots.length ; i++){
    		//Add each spot a marker object
    		
    			var position = new google.maps.LatLng($scope.spots[i]['lat'], $scope.spots[i]['lng']);
    			
    			var marker = new google.maps.Marker({
    				map: $scope.map,
    				position: position
    			});
    			
    			$scope.markers[i] = marker
    			
    		}
    		
    	});
    	
    };
    
    $scope.showBounds = function(){
    	alert("SouthWest:" + $scope.map.getBounds().getSouthWest().toString());
    	alert("NorthEast:" + $scope.map.getBounds().getNorthEast().toString());
    }
    
    
    /*
    $scope.addCenter = function(){
    	
    	var center = $scope.myMap.getCenter();
    	
    	var marker = new google.maps.Marker({
    		map: $scope.myMap,
    		position: center
    	});
    	
    	$scope.markers.push(marker);
    }
    */
    
}]);